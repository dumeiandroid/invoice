<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Resmi - Lidan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap');
        
        body { background-color: #f3f4f6; font-family: 'Times New Roman', Times, serif; }
        
        .paper {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm 20mm 20mm 20mm; 
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .line-header { border-bottom: 3px solid #BF1A54; margin-top: 5px; }
        .line-header-thin { border-bottom: 1px solid #BF1A54; margin-top: 2px; }

        @media print {
            body { background: none; padding: 0; }
            .paper { margin: 0; box-shadow: none; width: 100%; }
            .no-print { display: none; }
        }

        .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .invoice-table th { background-color: #BF1A54; color: white; padding: 12px; text-align: left; font-weight: bold; }
        .invoice-table td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; }
        
        /* Garis penutup tabel sebelum total */
        .invoice-table tr:last-child td { border-bottom: 2px solid #BF1A54; }
        
        .qr-area { width: 100px; height: 100px; }

        /* Style khusus untuk area total agar mirip dengan gambar referensi */
        .total-section {
            border-top: 2px solid #1e3a8a; /* Garis Biru Tua sesuai gambar */
            margin-top: 10px;
            padding-top: 10px;
        }
    </style>
</head>
<body>

    <div class="no-print fixed top-5 right-5 flex gap-2 z-50">
        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-700 transition">Cetak / Print</button>
        <button onclick="downloadPDF()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition">Download PDF (A4)</button>
    </div>

    <div class="paper" id="invoice-content">
        
        <div class="flex items-center gap-4 mb-0">
            <img src="https://lidan.co.id/gambar/logo-baru.png" alt="Logo Lidan" class="w-24 h-auto object-contain">
            <div class="flex-1 text-center">
                <h1 style="color: #BF1A54;" class="text-3xl font-bold uppercase tracking-widest">
                    PT Lidan Indah Abadi
                </h1>
                <p class="text-sm">Jl. Imam Bonjol No. 9, Regus Forum Nine Lt.9, Medan, Sumatera Utara</p>
                <p class="text-sm italic text-gray-600">Email: info@lidan.co.id | Website: lidan.co.id | Whatsapp: 0851 5960 1400</p>
            </div>
        </div>
        
        <div class="line-header"></div>
        <div class="line-header-thin"></div>

        <div id="loading" class="text-center py-20">
            <p class="animate-pulse font-bold text-gray-400">Menyusun Dokumen...</p>
        </div>

        <div id="invoice-isi" class="hidden mt-6">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h2 class="text-4xl font-black uppercase tracking-wider mb-2" style="color: #BF1A54;">INVOICE</h2>
                    <table class="text-sm">
                        <tr><td class="pr-4 font-bold">No. Invoice</td><td>: <span id="nomor-invoice" class="font-black"></span></td></tr>
                        <tr><td class="font-bold">Tanggal</td><td>: <span id="tanggal-invoice"></span></td></tr>
                        <tr><td class="font-bold text-red-600">Jatuh Tempo</td><td>: <span id="jatuh-tempo" class="text-red-600 font-black"></span></td></tr>
                    </table>
                </div>
                <div id="status-container" class="text-right">
                    <div id="status-badge" class="inline-block px-6 py-3 rounded-xl font-black text-lg uppercase"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-8">
                <div class="border-2 border-gray-200 p-5 rounded-lg">
                    <h3 class="font-bold text-sm mb-3 uppercase" style="color: #BF1A54;">Dari:</h3>
                    <p class="font-black text-lg">PT Lidan Indah Abadi</p>
                    <p class="text-sm mt-2">Jl. Imam Bonjol No. 9</p>
                    <p class="text-sm">Regus Forum Nine Lt.9</p>
                    <p class="text-sm">Medan, Sumatera Utara</p>
                    <p class="text-sm mt-2 font-bold">0851 5960 1400</p>
                </div>
                <div class="border-2 border-indigo-200 p-5 rounded-lg bg-indigo-50">
                    <h3 class="font-bold text-sm mb-3 uppercase text-indigo-700">Kepada:</h3>
                    <p id="nama-pelanggan" class="font-black text-lg text-indigo-900"></p>
                    <p id="alamat-pelanggan" class="text-sm mt-2 text-gray-700 leading-relaxed"></p>
                    <p id="kontak-pelanggan" class="text-sm mt-2 font-bold text-indigo-600"></p>
                </div>
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th class="text-left" style="width: 50%;">Deskripsi Item/Layanan</th>
                        <th class="text-center" style="width: 10%;">Qty</th>
                        <th class="text-right" style="width: 20%;">Harga Satuan</th>
                        <th class="text-right" style="width: 20%;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="items-tbody">
                </tbody>
            </table>

            <div class="flex justify-end">
                <div class="w-80 total-section">
                    <table class="w-full">
                        <tr>
                            <td class="py-2 font-black text-lg uppercase text-gray-800">TOTAL:</td>
                            <td id="total-display" class="py-2 text-right font-black text-3xl" style="color: #BF1A54;"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="catatan-section" class="mt-8 p-5 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                <p class="text-sm font-bold mb-2" style="color: #BF1A54;">Catatan / Notes:</p>
                <p id="catatan" class="text-sm text-gray-700 leading-relaxed"></p>
            </div>

            <div class="mt-10 border-t-2 pt-6">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-sm mb-3">Informasi Pembayaran:</h4>
                        <table class="text-sm">
                            <tr><td class="font-bold pr-3">Bank</td><td>: BCA</td></tr>
                            <tr><td class="font-bold">No. Rekening</td><td>: 1234567890</td></tr>
                            <tr><td class="font-bold">Atas Nama</td><td>: PT Lidan Indah Abadi</td></tr>
                        </table>
                        <p class="text-xs italic text-gray-500 mt-3">* Harap sertakan nomor invoice saat transfer</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm mb-3">Medan, <span id="tanggal-ttd"></span></p>
                        <p class="font-bold text-sm">PT Lidan Indah Abadi</p>
                        <div class="flex justify-end items-center mt-4 mb-16">
                            <div id="qrcode" class="qr-area p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        </div>
                        <p class="font-bold text-lg underline">Finance Department</p>
                        <p class="text-xs text-gray-400 mt-2 italic">Digital Signature Verified</p>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-8 left-8 right-8 pt-4 border-t text-center text-[9pt] text-gray-400 italic">
                <p>Invoice ini sah dan diterbitkan secara elektronik. Untuk verifikasi, scan QR Code atau kunjungi: lidan.co.id/sign/invoice</p>
                <p class="mt-1">ID: <span id="token-display" class="font-mono"></span></p>
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6';
        const TABLE_TARGET = 'invoice';
        const AUTH_KEY = 'admin';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        async function fetchInvoice() {
            if(!token) {
                document.getElementById('loading').innerHTML = "<span class='text-red-500'>Error: Token Tidak Ditemukan.</span>";
                return;
            }

            try {
                const res = await fetch(`${API_URL}?table=${TABLE_TARGET}&x_12_eq=${token}`, {
                    headers: { 'X-Custom-Auth': AUTH_KEY }
                });
                const result = await res.json();

                if(result.success && result.data.length > 0) {
                    renderInvoice(result.data[0]);
                } else {
                    document.getElementById('loading').innerHTML = "<span class='text-red-500'>Error: Data Invoice Tidak Valid.</span>";
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderInvoice(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('invoice-isi').classList.remove('hidden');

            document.getElementById('nomor-invoice').innerText = data.x_04 || '-';
            document.getElementById('tanggal-invoice').innerText = data.x_05 || '';
            document.getElementById('tanggal-ttd').innerText = data.x_05 || '';
            document.getElementById('jatuh-tempo').innerText = data.x_06 || '';
            
            document.getElementById('nama-pelanggan').innerText = data.x_01 || '-';
            document.getElementById('alamat-pelanggan').innerText = data.x_02 || '-';
            document.getElementById('kontak-pelanggan').innerText = data.x_03 || '-';

            const statusBadge = document.getElementById('status-badge');
            const status = data.x_13 || 'UNPAID';
            statusBadge.innerText = status;
            
            if(status === 'PAID') {
                statusBadge.className = 'inline-block px-6 py-3 rounded-xl font-black text-lg uppercase bg-green-100 text-green-700 border-2 border-green-300';
            } else if(status === 'OVERDUE') {
                statusBadge.className = 'inline-block px-6 py-3 rounded-xl font-black text-lg uppercase bg-red-100 text-red-700 border-2 border-red-300';
            } else {
                statusBadge.className = 'inline-block px-6 py-3 rounded-xl font-black text-lg uppercase bg-yellow-100 text-yellow-700 border-2 border-yellow-300';
            }

            try {
                const items = JSON.parse(data.x_07 || '[]');
                const tbody = document.getElementById('items-tbody');
                tbody.innerHTML = '';
                
                items.forEach((item) => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="font-semibold">${item.name}</td>
                            <td class="text-center font-bold">${item.qty}</td>
                            <td class="text-right">Rp ${parseInt(item.price).toLocaleString('id-ID')}</td>
                            <td class="text-right font-bold">Rp ${parseInt(item.total).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error('Error parsing items:', e);
            }

            // Menampilkan Total
            document.getElementById('total-display').innerText = 'Rp ' + parseInt(data.x_10 || 0).toLocaleString('id-ID');
            document.getElementById('token-display').innerText = data.x_12;

            if(data.x_11) {
                document.getElementById('catatan').innerText = data.x_11;
            } else {
                document.getElementById('catatan-section').classList.add('hidden');
            }

            const verificationUrl = `https://lidan.co.id/sign/invoice.html?token=${data.x_12}`;

            new QRCode(document.getElementById("qrcode"), {
                text: verificationUrl,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : 3
            });
        }

        function downloadPDF() {
            const element = document.getElementById('invoice-content');
            const nomorInvoice = document.getElementById('nomor-invoice').innerText.replace(/\//g, '_');
            const opt = {
                margin: 0,
                filename: `Invoice_${nomorInvoice}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 4, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        fetchInvoice();
    </script>
</body>
</html>